<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gdu.drawauction.dao.UserMapper">
	
	<select id="getUser" parameterType="Map" resultType="UserDto">
		SELECT USER_NO, EMAIL, PW, NAME, MOBILE, GENDER, AGREE, STATE, JOINED_AT, POSTCODE, ROAD_ADDRESS, JIBUN_ADDRESS, DETAIL_ADDRESS, NICKNAME, INTRODUCTION
		  FROM USER_T
		<where>
	      <if test="email != null">EMAIL = #{email}</if>
	      <if test="pw != null">AND PW = #{pw}</if>
	      <if test="userNo != null">AND USER_NO = #{userNo}</if>
	    </where>
	</select>

	
	<!--/* 접속기록 넣기 */-->
  <insert id="insertAccess" parameterType="String">
    INSERT INTO ACCESS_T (
    	EMAIL, LOGIN_AT
    ) VALUES (
		#{email}, SYSDATE
    )
  </insert>
	
	<select id="getLeaveUser" parameterType="Map" resultType="LeaveUserDto">
    SELECT EMAIL, JOINED_AT, LEAVED_AT
      FROM LEAVE_USER_T
     WHERE EMAIL = #{email}
  </select>

  <select id="getInactiveUser" parameterType="Map" resultType="InactiveUserDto">
    SELECT USER_NO, EMAIL, PW, NAME, MOBILE, GENDER, AGREE, STATE, JOINED_AT, POSTCODE, ROAD_ADDRESS, JIBUN_ADDRESS, DETAIL_ADDRESS, NICKNAME, INTRODUCTION, INACTIVED_AT
      FROM INACTIVE_USER_T
   <where>
      <if test="email != null">EMAIL = #{email}</if>
      <if test="pw != null">AND PW = #{pw}</if>
    </where>
  </select>
  
  <!--/* 사용자 추가하기 */-->
  <insert id="insertUser" parameterType="UserDto">
    INSERT INTO USER_T (
			USER_NO
		  , EMAIL
		  , PW
		  , NAME
		  , MOBILE
		  , GENDER
		  , AGREE
		  , STATE
		  , JOINED_AT
		  , POSTCODE
		  , ROAD_ADDRESS
		  , JIBUN_ADDRESS
		  , DETAIL_ADDRESS
		  , NICKNAME
    ) VALUES (
	        USER_SEQ.NEXTVAL
	      , #{email}
	      , #{pw}
	      , #{name}
	      , #{mobile}
	      , #{gender}
	      , #{agree}
	      , 0
	      , SYSDATE
	      , #{postcode}
	      , #{roadAddress}
	      , #{jibunAddress}
	      , #{detailAddress}
	      , #{nickname}
    )
  </insert>


	<!--/* 사용자 정보 수정하기 */-->
	<update id="updateUser" parameterType="UserDto">
		UPDATE USER_T
		   SET EMAIL = #{email}
             , NAME = #{name}
             , MOBILE = #{mobile}
		   	 , GENDER = #{gender}
		   	 , POSTCODE = #{postcode}
		   	 , AGREE = 0
		   	 , ROAD_ADDRESS = #{roadAddress}
		   	 , JIBUN_ADDRESS = #{jibunAddress}
		   	 , DETAIL_ADDRESS = #{detailAddress}
		   	 , NICKNAME = #{nickname}
		   	 , INTRODUCTION = #{introduction}
		 WHERE USER_NO = #{userNo}
	</update>

	<update id="updateUserPw" parameterType="UserDto">
		UPDATE USER_T
		   SET EMAIL = #{email}
             , PW = #{pw}
		 WHERE USER_NO = #{userNo};	
	</update>


	<!--/* 탈퇴한 사용자 INSERT */-->
	  <insert id="insertLeaveUser" parameterType="UserDto">
	    INSERT INTO LEAVE_USER_T (
	        EMAIL
	      , JOINED_AT
	      , LEAVED_AT
	    ) VALUES (
	        #{email}
	      , #{joinedAt}
	      , SYSDATE
	    )
	  </insert>

  
  <!--/* 유저 삭제하기 */-->
  <delete id="deleteUser" parameterType="UserDto">
    DELETE
      FROM USER_T
     WHERE USER_NO = #{userNo}
  </delete>
  
   <!--/* 휴면 유저 insert  */-->
  <insert id="insertInactiveUser">
    INSERT INTO INACTIVE_USER_T (
		SELECT U.USER_NO, U.EMAIL, U.PW, U.NAME, U.MOBILE, U.GENDER, U.AGREE, U.STATE, U.JOINED_AT, POSTCODE, ROAD_ADDRESS, JIBUN_ADDRESS, DETAIL_ADDRESS, NICKNAME, INTRODUCTION, A.LOGIN_AT 
		  FROM USER_T U LEFT OUTER JOIN ACCESS_T A
		    ON U.EMAIL = A.EMAIL
		 WHERE MONTHS_BETWEEN(SYSDATE, LOGIN_AT) >= 6
		    OR (LOGIN_AT IS NULL AND MONTHS_BETWEEN(SYSDATE, LOGIN_AT) >= 6))
  </insert>
  
  <delete id="deleteUserForInactive">
    DELETE
        FROM USER_T
	   WHERE EMAIL IN(SELECT U.EMAIL
                  FROM USER_T U LEFT OUTER JOIN ACCESS_T A
                    ON U.EMAIL = A.EMAIL
                 WHERE MONTHS_BETWEEN(SYSDATE, LOGIN_AT) >= 6
                    OR (LOGIN_AT IS NULL AND  MONTHS_BETWEEN(SYSDATE, JOINED_AT) >= 6))
  </delete>

  <insert id="insertActiveUser" parameterType="String">  
    INSERT INTO USER_T (
      SELECT USER_NO, EMAIL, PW, NAME, MOBILE, GENDER, AGREE, STATE, JOINED_AT, POSTCODE, ROAD_ADDRESS, JIBUN_ADDRESS, DETAIL_ADDRESS, NICKNAME, INTRODUCTION
        FROM INACTIVE_USER_T
       WHERE EMAIL = #{email}
    )
  </insert>

  <delete id="deleteInactiveUser" parameterType="String">
    DELETE
      FROM INACTIVE_USER_T
     WHERE EMAIL = #{email}  
  </delete>


	 <insert id="insertNaverUser" parameterType="UserDto">
    INSERT INTO USER_T (
			USER_NO, EMAIL, NAME, MOBILE, GENDER, AGREE, STATE, JOINED_AT, POSTCODE, ROAD_ADDRESS, JIBUN_ADDRESS, DETAIL_ADDRESS, NICKNAME
    ) VALUES (
    	USER_SEQ.NEXTVAL, #{email}, #{name}, #{mobile}, #{gender}, #{agree}, 0, SYSDATE, #{postcode}, #{roadAddress}, #{jibunAddress}, #{detailAddress}, #{nickname}
    )
  </insert>


</mapper>