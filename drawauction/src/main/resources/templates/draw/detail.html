<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{/layout/header::head(|${draw.userDto.nickname}의 게시글|)}"></head>
<style>
	
  body {
	  width: 100%;
	  font-family: 'Arial', sans-serif;
	  line-height: 1.6;
	  color: #333;
	  background-color: #f8f9fa;
	  margin: 0;
	  display: flex;
	  flex-direction: column;
	  align-items: center;
	  justify-content: center;
	  min-height: 100vh;
	}

    .main_wrap {
      width: 90%;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .wrap_6 {
      position: relative;
      width: 80%;
    }

    .artist-info {
      display: inline-block;
      position: relative;
      margin-bottom: 20px;
    }

    #wish_list {
      cursor: pointer;
      position: absolute;
      top: 11%;
      right: 0;
      color: #ff0000;
    }

    h1.title {
      font-size: 24px;
      margin-bottom: 20px;
    }

    .btn {
      display: inline-block;
      margin-right: 10px;
    }

    hr {
      margin: 20px 0;
      border: none;
      border-top: 1px solid #ddd;
    }

   .image img {
        width: 100%; 
        height: auto; 
        object-fit: cover; 
    }
    
    .image-container {
        display: flex;
        flex-wrap: wrap;  
        overflow-x: auto;
    }


    
    .image {
      flex: 0 0 auto;
      width: 600px;
      height: auto;
      margin: 20px;
    }
    
    #review_list {
      margin-top: 20px;
    }
    
    .header {
	  text-align: center;
	}
	
	.header h2 {
	  margin: 0;
	}
</style>

<body>
  
  <div th:replace="~{/layout/header::header}"></div>
  
  <div class="main_wrap">

    <div class="wrap wrap_6 ">
    
      <h1 class="title" th:text="|${draw.userDto.nickname}의 그려드림|"></h1>
      
      <div class="text-center mb-5">
        <th:block th:if="${session.user != null}">
          <th:block th:if="${session.user.userNo == draw.userDto.userNo}">
            <form id="frm_btn">
              <input type="hidden" id="drawNo" name="drawNo" th:value="${draw.drawNo}">
              <button type="button" id="btn_edit" class="btn btn-warning btn-sm">편집</button>
              <button type="button" id="btn_remove" class="btn btn-danger btn-sm">삭제</button>
            </form>
          </th:block>
        </th:block>
      </div>
      <div class="artist-info" th:text="|작가 : ${draw.userDto.nickname}|"></div>
      <i id="wish_list" th:class="|${draw.heart} fa-heart fa-2xl|" style="color: #ff0000;"></i>
      <div th:text="|카테고리 : ${draw.categoryDto.categoryName}|"></div>
      <div th:text="|제목 : ${draw.title}|"></div>
      <div th:text="|가격 : ${#numbers.formatInteger(draw.price, 0, 'COMMA')}P|"></div>
      <div th:text="|작품 가로길이(px) : ${draw.width}|"></div>
      <div th:text="|작품 세로길이(px) : ${draw.height}|"></div>
      <div th:text="|작업기간 : 결제일로부터 ${draw.workTerm} 일|"></div>
      <input type="hidden" id="drawNo2" name="drawNo2" th:value="${draw.drawNo}">
      
      <div>내용</div>
      <th:block th:if="${#strings.isEmpty(draw.contents)}">
        <div>내용없음</div>
      </th:block>
      <th:block th:if="${not #strings.isEmpty(draw.contents)}">
        <div th:text="${draw.contents}"></div>
      </th:block>
      
      <hr>
      
      <h5>그림 예시</h5>
      <div class="image-container">
        <th:block th:if="${#lists.isEmpty(imageList)}">
          <div>첨부 없음</div>          
        </th:block>
        <th:block th:if="${not #lists.isEmpty(imageList)}">
          <th:block th:each="img:${imageList}">
            <div class="image" th:data-image_no="${img.drawImageNo}">
              <th:block th:if="${img.hasThumbnail == 1}">
                <img th:src="@{|${img.path}/s_${img.filesystemName}|}" alt="썸네일">
              </th:block>
              <th:block th:if="${img.hasThumbnail == 0}">
                <img th:src="@{/image/image1.png}" alt="썸네일" width="50">
              </th:block>
            </div>
          </th:block>
        </th:block>
      </div>
      
      <hr>
      
      <div>
        <form id="frm_review_add" method="post" action="/draw/addReview.do">
          <div class="input-group mb-3">
            <!-- 로그인 안 한 경우 -->
            <th:block th:if="${session.user == null}">              
              <input type="hidden" name="userNo" th:value="0">
            </th:block>
            <!-- 로그인 한 경우 -->
            <th:block th:if="${session.user != null and orderReview != null and session.user.userNo == orderReview.userDto.userNo}">
              <input type="hidden" name="userNo" th:value="${session.user.userNo}">
              <input type="hidden" name="drawNo" th:value="${draw.drawNo}">
              <div>
	            <label for="rating" class="form-label">별점</label>
	            <div>
		          <select name="rating" id="rating">
			        <option value="1">1</option>  
			        <option value="2">2</option>  
				    <option value="3">3</option>  
				    <option value="4">4</option>  
				    <option value="5">5</option>  
				  </select>
				</div>
			  </div>
              <textarea rows="5" name="reviewContents" class="form-control" id="reviewContents" placeholder="후기를 작성해 주세요"></textarea>
              <button type="submit" class="btn btn-primary btn-sm" id="btn_review_add">작성완료</button>
            </th:block>
          </div>
        </form>
      </div>
	 
	<div>
	  <h4>상품후기</h4>
	  <div id="review_container"class="form-control">
	    <table id="review_container2" class="table">
	      <thead>
	        <tr>
	          <th>작성자</th>
	          <th>별점</th>
	          <th>내용</th>
	          <th>작성일</th>
	        </tr>
	      </thead>
	      <tbody id="review_list">
	      </tbody>
	    </table>
	  </div>
	</div>
	        
    </div>
      
    <script th:inline="javascript">
  	  // 전역 변수
      var frmBtn = $('#frm_btn');
      var page = 1;
      var totalPage = 0;
      var drawNo = $('#drawNo2').val();
      
      const fnEdit = () => {
        $('#btn_edit').click(() => {
          frmBtn.attr('action', '/draw/edit.form');
          frmBtn.attr('method', 'get');
          frmBtn.submit();
        })
      }
      
      const fnRemove = () => {
        $('#btn_remove').click(() => {
          if(confirm('해당 게시글을 삭제할까요?')){
            frmBtn.attr('action', '/draw/removeDraw.do');
            frmBtn.attr('method', 'post');
            frmBtn.submit();
          }
        })
      }
    
      const fnModifyResult = () => {
        let modifyResult = /*[[${modifyResult}]]*/ null;
        if(modifyResult !== null){
          if(modifyResult === 1){
            alert('게시글이 수정되었습니다.');
          } else {
            alert('게시글이 수정되지 않았습니다.');
          }
        }
      }
     
      const fnWishListControll = () => {
		$('#wish_list').click(() => {
		  $.ajax({
			type: 'post',
		    url: '/draw/WishListControll.do',
		    data: { 
					drawNo: drawNo,
			  	  },
		    dataType: 'json',
		    success: (resData) => {
			  if(resData.addWishResult == 1) {
			    $('#wish_list').removeClass('fa-regular fa-heart fa-2xl');
			    $('#wish_list').addClass('fa-solid fa-heart fa-2xl');
			  } else if(resData.removeWishResult == 1) {
			    $('#wish_list').removeClass('fa-solid fa-heart fa-2xl');
				$('#wish_list').addClass('fa-regular fa-heart fa-2xl');
			  }
		    }
			
		  })
		})
	  }
	  
	  const fnScroll = () => {
        
      var timerId;  // 최초 undefined 상태
        
      $(window).on('scroll', () => {
          
        if(timerId){  // timerId가 undefined이면 false로 인식, timerId가 값을 가지면 true로 인식
          clearTimeout(timerId);
        }
          
        timerId = setTimeout(() => {  // setTimeout 실행 전에는 timerId가 undefined 상태, setTimeout이 한 번이라도 동작하면 timerId가 값을 가짐
            
          let scrollTop = $(window).scrollTop();     // 스크롤바 위치(스크롤 된 길이)
          let windowHeight = $(window).height();     // 화면 전체 크기
          let documentHeight = $(document).height(); // 문서 전체 크기
            
          if((scrollTop + windowHeight + 100) >= documentHeight) {  // 스크롤이 바닥에 닿기 100px 전에 true가 됨
            if(page > totalPage){  // 마지막 페이지를 보여준 이후에 true가 됨
              return;              // 마지막 페이지를 보여준 이후에는 아래 코드를 수행하지 말 것 
            }
            page++;
            fnReviewtList();
          }
            
        }, 200);  // 200밀리초(0.2초) 후 동작(시간은 임의로 조정 가능함)
      })
    }
    
    const fnReviewtList = () => {
      $.ajax({
        // 요청
        type: 'get',
        url: '/draw/getReviewList.do',
        data: 'page=' + page + '&drawNo=[[${draw.drawNo}]]',
        // 응답
        dataType: 'json',
        success: (resData) => {
          $('#review_list').empty();
          if(resData.reviewList.length === 0){
            $('#review_container2').css('display', 'none');
            $('#review_container').html('<div class="text-center my-3">작성된 후기가 없습니다.</div>');
            return;
          }
          $.each(resData.reviewList, (i, r) => {
	      var createdAt = new Date(r.createdAt);
	 	  var formattedCreatedAt = createdAt.toISOString().slice(0, 16).replace('T', ' ');
            let str = '<tr>';
            str += '<td style="color: #1E90FF">' + r.userDto.nickname + '</td>';
            str += '<td>' + r.rating + '</td>';
            str += '<td>' + r.reviewContents + '</td>';
            str += '<td style="font-size: 12px;">' + formattedCreatedAt + '</td>';
            str += '</tr>';
            $('#review_list').append(str);
            })
          }
        })
      }
      
      const fnReviewResult = () => {
      let addReviewResult = /*[[${addReviewResult}]]*/ null;
      if(addReviewResult !== null){
        if(addReviewResult === 1){
          alert('후기가 작성되었습니다.');
        } else {
          alert('후기 작성이 실패했습니다.');
        }
      }
    }
      
          
      fnReviewResult();    
	  fnReviewtList();
      fnScroll();
      fnEdit();
      fnRemove();
      fnModifyResult();
      fnWishListControll();
      fnReviewtList();
      
    </script>
      
  </div>
  
  <div th:replace="~{/layout/footer::footer}"></div>
  
</body>
</html>